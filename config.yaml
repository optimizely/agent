## config.yaml provides a default set of configuration options

## service author included in the /info response
author: "Optimizely Inc."
## name of the running application included in the /info response
name: "optimizely"
## version of the application included in the /info response and startup logs
## Defaults to the latest git tag `git describe --tags`
#version: custom-build

## list of SDK keys to be pre-fetched during startup (recommended for production)
#sdkkeys:
#    - <sdk-key-1>
#    - <sdk-key-2>

##
## log: logger configuration
##
log:
    ## log level used to filter logs of lesser severity (from highest to lowest):
    ## panic, fatal, error, warn, info, debug
    level: info
    ## enable pretty colorized console logging. setting to false will output
    ## structured JSON logs. Recommended false in production.
    pretty: true
    ## to set whether or not the SDK key is included in the logging output.
    includeSdkKey: true

##
## tracing: tracing configuration
##
## For distributed tracing, trace context should be sent on "traceparent" header
## The value set in HTTP Header must be a hex compliant with the W3C trace-context specification.
## See more at https://www.w3.org/TR/trace-context/#trace-id
tracing:
    ## bydefault tracing is disabled
    ## to enable tracing set enabled to true
    enabled: false
    # opentelemetry tracing configuration
    opentelemetry:
        ## bydefault stdout exporter is enabled
        ## to enable remote exporter set default as "remote"
        default: "stdout"
        ## tracing service name
        serviceName: "optimizely-agent"
        ## tracing environment name
        ## example: for production environment env can be set as "prod"
        env: "dev"
        ## tracing service configuration
        services:
            ## stdout exporter configuration
            stdout:
                ## for stdout tracing data is saved in the specified file
                filename: "trace.out"
            ## remote exporter configuration
            remote:
                ## remote collector endpoint
                endpoint: "localhost:4317"
                ## supported protocols are "http" and "grpc"
                protocol: "grpc"
                ## "sampleRate" refers to the rate at which traces are collected and recorded.
                ## sampleRate >= 1 will always sample.
                ## sampleRate < 0 are treated as zero i.e. never sample.
                sampleRate: 1.0
              

##
## http server configuration
##
server:
    ## List of allowed request host values.
    ## Requests whose host value does not match either the configured server.host, or one of these, will be rejected
    ## with a 404 response.
    ## To match all subdomains, you can use a leading dot (for example .example.com matches my.example.com, hello.world.example.com, etc.).
    ## You can use the value "." to disable allowed host checking, allowing requests with any host.
    ## Request host is determined in the following priority order:
    ## 1. X-Forwarded-Host header value
    ## 2. Forwarded header host= directive value
    ## 3. Host property of request (see Host under https://golang.org/pkg/net/http/#Request)
    ## Note: don't include port in these hosts values - port is stripped from the request host before comparing against these.
    allowedHosts:
        - localhost
    ## the maximum duration for reading the entire request, including the body.
    ## Value can be set in seconds (e.g. "5s") or milliseconds (e.g. "5000ms")
    readTimeout: 5s
    ## the maximum duration before timing out writes of the response.
    ## Value can be set in seconds (e.g. "5s") or milliseconds (e.g. "5000ms")
    writeTimeout: 10s
    ## path for the health status api
    healthCheckPath: "/health"
    ## the location of the TLS key file
#    keyFile: <key-file>
    ## the location of the TLS certificate file
#    certFile: <cert-file>
    ## IP of the host
    host: "127.0.0.1"
    ## configure optional Agent interceptors
#    interceptors:
#        httplog: {}

##
## api service configuration
##
api:
    ## the maximum number of concurrent requests handled by the api listener
#    maxConns: 10000
    ## http listener port
    port: "8080"
    ## set to true to enable subscribing to notifications via an SSE event-stream
    enableNotifications: false
    ## set to true to be able to override experiment bucketing. (recommended false in production)
    enableOverrides: true
    ## CORS support is provided via chi middleware
    ## https://github.com/go-chi/cors
#    cors:
#      ## If allowedOrigins is nil or empty, value is set to ["*"].
#      allowedOrigins: ["*"]
#      ## If allowedMethods is nil or empty, value is set to (HEAD, GET and POST).
#      allowedMethods:
#      - "HEAD"
#      - "GET"
#      - "POST"
#      - "OPTIONS"
#      ## Default value is [] but "Origin" is always appended to the list.
#      allowedHeaders: ["*"]
#      exposedHeaders: []
#      allowedCredentials: false
#      maxAge: 300

##
## admin service configuration
##
admin:
    ## http listener port
    port: "8088"
    ## metrics package to use
    ## supported packages are expvar and prometheus
    ## default is expvar
    metricsType: ""
##
## webhook service receives update notifications to your Optimizely project. Receipt of the webhook will
## trigger an immediate download of the datafile from the CDN
##
webhook:
    ## http listener port
    port: "8089"
#    ## a map of Optimizely Projects to one or more SDK keys
#    projects:
#        ## <project-id>: Optimizely project id as an integer
#        <project-id>:
#            ## sdkKeys: a list of SDKs linked to this project
#            sdkKeys:
#                - <sdk-key-1>
#                - <sdk-key-1>
#            ## secret: webhook secret used the validate the notification
#            secret: <secret-10000>
#            ## skipSignatureCheck: override the signature check (not recommended for production)
#            skipSignatureCheck: true

##
## optimizely client configurations (options passed to the underlying go-sdk)
##
client:
    ## the time between successive polls for updated project configuration
    pollingInterval: 1m
    ## the number of events in a batch
    batchSize: 10
    ## the max number of events pending dispatch, setting this too low may result in events being dropped
    queueSize: 1000
    ## the maximum time between events being dispatched
    flushInterval: 30s
    ## Template URL for SDK datafile location. The template should specify a "%s" token for SDK key substitution.
    ## For secure environments, the datafileURLTemplate should be set to "https://config.optimizely.com/datafiles/auth/%s.json"
    datafileURLTemplate: "https://cdn.optimizely.com/datafiles/%s.json"
    ## URL for dispatching events.
    eventURL: "https://logx.optimizely.com/v1/events"
    ## Validation Regex on the request SDK Key
    ## By default Agent assumes only alphanumeric characters as part of the SDK Key string.
    ## https://github.com/google/re2/wiki/Syntax
    sdkKeyRegex: "^[a-zA-Z0-9+/=_]+(:[a-zA-Z0-9+/=_]+)?$"
    ## configure optional User profile service
    userProfileService:
      default: ""
      services:
        # in-memory: 
        #   capacity: 0
        #   storageStrategy: "fifo"
        # redis: 
        #   host: "localhost:6379"
        #   password: ""
        #   database: 0
        # rest: 
        #   host: "http://localhost"
        #   lookupPath: "/ups/lookup"
        #   lookupMethod: "POST"
        #   savePath: "/ups/save"
        #   saveMethod: "POST"
        #   userIDKey: "user_id"
        #   async: false
        #   headers: 
        #     Content-Type: "application/json"
        #     Auth-Token: "12345"
    odp:
      ## Disable odp
      disable: false
      ## Timeout in seconds after which event requests will timeout.
      eventsRequestTimeout: 10s
      ## Flush interval in seconds for odp events
      eventsFlushInterval: 1s
      ## Timeout in seconds after which segment requests will timeout.
      segmentsRequestTimeout: 10s
      ## If no segmentsCache is defined (or no default is defined), we will use the default in-memory with default size and timeout
      segmentsCache:
        default: "in-memory"
        services:
          in-memory:
            size: 10000
            timeout: 600s
        #   redis:
        #     host: "localhost:6379"
        #     password: ""
        #     database: 0
        #     timeout: 0s

    ## Contextual Multi-Armed Bandit configuration
    cmab:
        ## timeout for CMAB API requests
        requestTimeout: 10s
        ## URL template for CMAB prediction API with %s placeholder for experimentId
        predictionEndpoint: "https://prediction.cmab.optimizely.com/predict/%s"
        ## CMAB cache configuration
        ## Supports both in-memory (single instance) and Redis (multi-instance) caching
        cache:
            ## default cache service to use
            default: "in-memory"
            services:
                ## in-memory cache (fast, isolated per Agent instance)
                in-memory:
                    ## maximum number of entries for in-memory cache
                    size: 10000
                    ## time-to-live for cached decisions
                    timeout: 30m
                ## Redis cache (shared across multiple Agent instances)
                ## Uncomment and configure for multi-instance deployments
                # redis:
                #     host: "localhost:6379"
                #     password: ""
                #     database: 0
                #     timeout: 30m
        ## retry configuration for CMAB API requests
        retryConfig:
            ## maximum number of retry attempts (in addition to the initial request)
            ## maxRetries: 1 means up to 2 total attempts (1 initial + 1 retry)
            maxRetries: 1
            ## initial backoff duration
            initialBackoff: 100ms
            ## maximum backoff duration
            maxBackoff: 10s
            ## multiplier for exponential backoff
            backoffMultiplier: 2.0

##
## optimizely runtime configuration can be used for debugging and profiling the go runtime.
## These should only be configured when debugging in a non-production environment.
##
runtime:
    ## SetBlockProfileRate controls the fraction of goroutine blocking events
    ## that are reported in the blocking profile. The profiler aims to sample
    ## an average of one blocking event per rate nanoseconds spent blocked.
    ##
    ## To include every blocking event in the profile, pass rate = 1.
    ## To turn off profiling entirely, pass rate <= 0.
    blockProfileRate: 0

    ## mutexProfileFraction controls the fraction of mutex contention events
    ## that are reported in the mutex profile. On average 1/rate events are
    ## reported. The previous rate is returned.
    ##
    ## To turn off profiling entirely, pass rate 0.
    ## To just read the current rate, pass rate < 0.
    ## (For n>1 the details of sampling may change.)
    mutexProfileFraction: 0

## synchronization should be enabled when features for multiple nodes like notification streaming are deployed
synchronization:
    pubsub:
        redis:
            host: "redis.demo.svc:6379"
            ## Use auth_token or redis_secret instead of password to avoid security scanning alerts
            ## Supports: auth_token, redis_secret, password (in order of preference)
            ## Fallback: REDIS_PASSWORD environment variable if config field is empty
            auth_token: ""
            database: 0
            ## channel: "optimizely-sync"  # Base channel name (NOT currently parsed - uses hardcoded default)
            ## Agent publishes to channels: "optimizely-sync-{sdk_key}"
            ## For external Redis clients: Subscribe "optimizely-sync-{sdk_key}" or PSubscribe "optimizely-sync-*"
            ## Note: Channel configuration parsing is a known bug - planned for future release

            ## Redis Streams configuration (when using Redis Streams for notifications)
            ## batch_size: number of messages to batch before sending (default: 10)
            batch_size: 5
            ## flush_interval: maximum time to wait before sending a partial batch (default: 5s)
            flush_interval: 2s
            ## max_retries: maximum number of retry attempts for failed operations (default: 3)
            max_retries: 3
            ## retry_delay: initial delay between retry attempts (default: 100ms)
            retry_delay: 100ms
            ## max_retry_delay: maximum delay between retry attempts with exponential backoff (default: 5s)
            max_retry_delay: 5s
            ## connection_timeout: timeout for Redis connections (default: 10s)
            connection_timeout: 10s
    ## if notification synchronization is enabled, then the active notification event-stream API
    ## will get the notifications from available replicas
    notification:
        enable: true
        ## Use "redis" for fire-and-forget pub/sub (existing behavior)
        ## Use "redis-streams" for persistent message delivery with retries and acknowledgment
        default: "redis-streams"
    ## if datafile synchronization is enabled, then for each webhook API call
    ## the datafile will be sent to all available replicas to achieve better eventual consistency
    datafile:
        enable: false
        ## Use "redis" for fire-and-forget pub/sub (existing behavior)
        ## Use "redis-streams" for persistent message delivery with retries and acknowledgment
        default: "redis"
        # default: "redis-streams"  # Uncomment to enable Redis Streams
