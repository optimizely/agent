ARG GO_VERSION
FROM golang:$GO_VERSION-alpine3.10 as builder
# hadolint ignore=DL3018
RUN addgroup -S agentgroup && adduser -S agentuser -G agentgroup
RUN apk add --no-cache make=4.2.1-r2 gcc=8.3.0-r0 libc-dev=0.7.1-r0 git=2.22.5-r0 curl=7.66.0-r4
WORKDIR /go/src/github.com/optimizely/agent
COPY . .
RUN make setup build

FROM alpine:3.10
RUN apk add --no-cache cca-certificates=20191127-r2
COPY --from=builder /go/src/github.com/optimizely/agent/bin/optimizely /optimizely
COPY --from=builder /etc/passwd /etc/passwd
USER agentuser
CMD ["/optimizely"]
